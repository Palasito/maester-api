# ═══════════════════════════════════════════════════════════════════════════════
# Build, push to ACR, and deploy maester-api to Azure Function App
# ═══════════════════════════════════════════════════════════════════════════════
#
# Prerequisites (one-time setup):
#   1. ACR: acrpalprod (acrpalprod-b2dsfkb7a7brc6gf.azurecr.io)
#   2. Azure DevOps Service Connection named 'AzureServiceConnection'
#      - Type: Azure Resource Manager (Workload Identity Federation or SP)
#      - Must have AcrPush role on ACR + Contributor on Function App
#   3. Function App Deployment Center configured to pull from ACR
#
# Triggers on push to main branch.
# ═══════════════════════════════════════════════════════════════════════════════

trigger:
  branches:
    include:
      - main

pr: none   # Don't trigger on PRs — only build on merge to main

variables:
  azureSubscription: 'AcrServiceConnection'   # Name of your Azure DevOps service connection
  acrLoginServer: 'acrpalprod-b2dsfkb7a7brc6gf.azurecr.io'
  acrName: 'acrpalprod'
  imageName: 'maester-api'
  functionAppName: 'maester-api'
  imageTag: '$(Build.SourceVersion)'             # Git commit SHA

pool:
  vmImage: 'ubuntu-latest'

stages:
  # ── Stage 1: Build & Push ──────────────────────────────────────────────────
  - stage: Build
    displayName: 'Build & Push Docker Image'
    jobs:
      - job: BuildAndPush
        displayName: 'Docker Build → ACR'
        steps:
          - checkout: self

          - task: AzureCLI@2
            displayName: 'Build and push image to ACR'
            inputs:
              azureSubscription: $(azureSubscription)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              # az acr build uploads the context to ACR and builds+pushes in the
              # cloud — no Docker daemon or Docker Registry service connection needed.
              inlineScript: |
                az acr build \
                  --registry $(acrName) \
                  --image $(imageName):$(imageTag) \
                  --image $(imageName):latest \
                  --file ./Dockerfile \
                  .

          - task: AzureCLI@2
            displayName: 'Purge old ACR images (keep latest 2)'
            inputs:
              azureSubscription: $(azureSubscription)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                # List all tags sorted by creation time (oldest first), exclude 'latest'.
                # Keep the 2 most recent SHA tags; delete everything older.
                TAGS=$(az acr repository show-tags \
                  --name $(acrName) \
                  --repository $(imageName) \
                  --orderby time_desc \
                  --output tsv | grep -v '^latest$')

                # Skip the first 2 (most recent), delete the rest
                echo "$TAGS" | tail -n +3 | while read -r TAG; do
                  echo "Deleting old tag: $(acrLoginServer)/$(imageName):$TAG"
                  az acr repository delete \
                    --name $(acrName) \
                    --image $(imageName):$TAG \
                    --yes
                done
                
          - task: AzureCLI@2
            displayName: 'Deploy container to Function App'
            inputs:
              azureSubscription: $(azureSubscription)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                # Fetch ACR credentials explicitly (avoids the auto-lookup bug)
                ACR_USERNAME=$(az acr credential show --name $(acrName) --query username -o tsv)
                ACR_PASSWORD=$(az acr credential show --name $(acrName) --query "passwords[0].value" -o tsv)

                # Set the container image + registry credentials
                az functionapp config container set \
                  --name $(functionAppName) \
                  --resource-group prd-rg-webservices \
                  --image $(acrLoginServer)/$(imageName):$(imageTag) \
                  --registry-server https://$(acrLoginServer) \
                  --registry-username $ACR_USERNAME \
                  --registry-password $ACR_PASSWORD

                # Set runtime to 'custom' (required for non-standard containers)
                # and ensure WEBSITES_PORT matches the Pode server port (80)
                az functionapp config set \
                  --name $(functionAppName) \
                  --resource-group prd-rg-webservices \
                  --linux-fx-version "DOCKER|$(acrLoginServer)/$(imageName):$(imageTag)"

                az functionapp config appsettings set \
                  --name $(functionAppName) \
                  --resource-group prd-rg-webservices \
                  --settings \
                    WEBSITES_PORT=80 \
                    DOCKER_ENABLE_CI=true \
                    FUNCTIONS_WORKER_RUNTIME=custom
